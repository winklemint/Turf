{{template "header.html"}}
<div class="pd-ltr-20 xs-pd-20-10">
    <div class="min-height-200px">
        <div class="page-header">
            <div class="row">
                <div class="col-md-6 col-sm-12">
                    <div class="title">
                        <h4>Form</h4>
                    </div>
                    <nav aria-label="breadcrumb" role="navigation">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="index.html">Home</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">
                                Form Basic
                            </li>
                        </ol>
                    </nav>
                </div>
                <div class="col-md-6 col-sm-12 text-right">
                    <div class="dropdown">
                        <a class="btn btn-secondary dropdown-toggle" href="#" role="button" data-toggle="dropdown">
                            January 2018
                        </a>
                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="#">Export List</a>
                            <a class="dropdown-item" href="#">Policies</a>
                            <a class="dropdown-item" href="#">View Assets</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Default Basic Forms Start -->
        <div class="pd-20 card-box mb-30">
            <div class="clearfix">
                <div class="pull-left">
                    <h4 class="text-blue h4">Package</h4>

                </div>
                <!-- <div class="pull-right">
                            <a
                                href="#basic-form1"
                                class="btn btn-primary btn-sm scroll-click"
                                rel="content-y"
                                data-toggle="collapse"
                                role="button"
                                ><i class="fa fa-code"></i> Source Code</a
                            >
                        </div> -->
            </div>
            <form id="package_form">
                <div class="form-group row">
                    <label class="col-sm-12 col-md-2 col-form-label">Start Date</label>
                    <div class="col-sm-12 col-md-10">
                        <input id="start-date" class="form-control" type="date" placeholder="Start Date" required />
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-sm-12 col-md-2 col-form-label">End Date</label>
                    <div class="col-sm-12 col-md-10">
                        <input id="end-date" class="form-control" placeholder="End Date" type="date" required />
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-12 col-md-2 col-form-label">Branch Name</label>
                    <div class="col-sm-12 col-md-10">
                        <select class="custom-select col-12" id="branchSelect" required>

                        </select>
                    </div>
                </div>


                <div class="form-group row">
                    <label class="col-sm-12 col-md-2 col-form-label">Available Slots</label>
                    <div class="col-sm-12 col-md-10" id="slot_date_container">
                        <!-- Checkboxes will be appended here -->
                        <div class="slot-grid"></div>
                    </div>
                </div>



                <input class="btn btn-primary" type="submit" value="Submit" id="submit" />

        </div>

        </form>
        <div class="collapse collapse-box" id="basic-form1">
            <div class="code-box">
                <div class="clearfix">
                    <a href="javascript:;" class="btn btn-primary btn-sm code-copy pull-left"
                        data-clipboard-target="#copy-pre"><i class="fa fa-clipboard"></i> Copy Code</a>
                    <a href="#basic-form1" class="btn btn-primary btn-sm pull-right" rel="content-y"
                        data-toggle="collapse" role="button"><i class="fa fa-eye-slash"></i> Hide Code</a>
                </div>
                <pre><code class="xml copy-pre" id="copy-pre"></code></pre>
            </div>
        </div>
    </div>
    <!-- Default Basic Forms End -->
</div>
<div class="footer-wrap pd-20 mb-20 card-box">
    DeskApp - Bootstrap 4 Admin Template By
    <a href="https://github.com/dropways" target="_blank">Ankit Hingarajiya</a>
</div>
</div>



{{template "footer.html"}}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var startDateInput = document.getElementById("start-date");
        var endDateInput = document.getElementById("end-date");

        // Add an event listener to the start date input
        startDateInput.addEventListener("change", function () {
            // Get the selected start date
            var selectedStartDate = new Date(startDateInput.value);

            // Disable all dates before the selected start date in the end date input
            endDateInput.min = startDateInput.value;

            // If the selected end date is before the selected start date, reset the end date
            if (new Date(endDateInput.value) < selectedStartDate) {
                endDateInput.value = startDateInput.value;
            }
        });
    });
</script>


<script>
    $(document).ready(function () {


        var selectedSlotIDs = [];
        var formattedStartDate; // Declare the variable here
        var formattedEndDate;

        var initialURL = window.location.href; // Replace with your actual URL
        var idMatch = initialURL.match(/id=(\d+)/);

        if (idMatch) {
            var id = idMatch[1];
            console.log("ID extracted:", id);
        } else {
            console.log("ID not found in the URL");
        }

        // Function to format the date from "yyyy-MM-dd" to "dd-MM-yyyy"
        function formatDateToDDMMYYYY(dateString) {
            var parts = dateString.split('-');
            if (parts.length === 3) {
                var year = parts[0];
                var month = parts[1];
                var day = parts[2];
                return day + '-' + month + '-' + year;
            }
            return dateString; // Return as is if the format is not "yyyy-MM-dd"
        }

        // Event listener to format the Start Date input
        $("#start-date").on('change', function () {
            var startDate = $(this).val();
            var formattedStartDate = formatDateToDDMMYYYY(startDate);
            updateInputField("#start-date", formattedStartDate);
        });

        // Event listener to format the End Date input
        $("#end-date").on('change', function () {
            var endDate = $(this).val();
            var formattedEndDate = formatDateToDDMMYYYY(endDate);
            updateInputField("#end-date", formattedEndDate);
        });

        $.ajax({
            url: '/admin/get/branch',
            method: 'GET',
            dataType: 'json',
            success: function (res) {
                $("#branchSelect").html('');
                appendDataToSelect(res.data);
            },
            error: function () {
                console.error('Failed to retrieve data from the server');
            }
        });

        function appendDataToSelect(data) {
            const element = "<option value=''>Select Branch</option>";
            $("#branchSelect").append(element);
            for (let index = 0; index < data.length; index++) {
                var element_other = "<option value='" + data[index].ID + "'>" + data[index].Branch_name + "</option>";
                $("#branchSelect").append(element_other);
            }
        }

        // Function to check if all fields have values
        function allFieldsFilled() {
            var startDate = $("#start-date").val();
            var endDate = $("#end-date").val();
            var branchName = $("#branchSelect").val();
            return startDate && endDate && branchName;
        }

        // Function to handle the AJAX request
        function makeAjaxRequest() {
            if (allFieldsFilled()) {
                formattedStartDate = formatDateToDDMMYYYY($("#start-date").val());
                formattedEndDate = formatDateToDDMMYYYY($("#end-date").val());

                // All fields are filled, so make the AJAX request with formatted dates
                $.ajax({
                    url: '/admin/get/avl/multi/slot',
                    method: 'POST',
                    data: {
                        Start_date: formattedStartDate,
                        End_date: formattedEndDate,
                        Branch_id: parseInt($("#branchSelect").val())
                    },
                    dataType: 'json',
                    success: function (response) {
                        console.log(response);
                        $("#slot_date_container").empty();

                        // Iterate over the response array
                        response.available_slots.forEach(function (slotsData) {
                            const date = slotsData.Date;


                            const availableSlots = slotsData.Available_slots;

                            // Create a container for each date
                            const dateContainer = $('<div></div>').addClass('date-container');
                            dateContainer.append('<h5>' + date + '</h5>');

                            // Check if availableSlots is an array
                            if (Array.isArray(availableSlots)) {
                                // Iterate over the inner array (availableSlots)
                                availableSlots.forEach(function (slot) {
                                    const isBooked = slot.Is_booked;
                                    const slotID = slot.Slot.ID;
                                    const slotName = slot.Slot.Start_time + " - " + slot.Slot.End_time;

                                    var checkbox = $('<input type="checkbox">')
                                        .attr('id', slotID)
                                        .attr('value', slotID)
                                        .attr('name', 'slots[]')
                                        .addClass('custom-control-input auth');

                                    const label = $('<label></label>')
                                        .text(slotName)
                                        .addClass('custom-control-label')
                                        .attr('for', slotID);

                                    if (isBooked == 1) {
                                        checkbox.prop('disabled', false);
                                    } else {
                                        checkbox.prop('disabled', true);
                                    }

                                    const div = $('<div></div>').addClass('custom-control custom-checkbox mb-5');
                                    div.append(checkbox);
                                    div.append(label);

                                    // Add a click event listener to track selected slots
                                    checkbox.on('click', function () {
                                        if (checkbox.is(':checked')) {
                                            selectedSlotIDs.push(slotID);
                                        } else {
                                            selectedSlotIDs = selectedSlotIDs.filter(id => id !== slotID);
                                        }
                                    });

                                    dateContainer.append(div); // Append the slot to the dateContainer
                                });
                            }
                            else {
                                // Handle no data or invalid response
                                dateContainer.append("No available slots");
                            }

                            $("#slot_date_container").append(dateContainer);
                        });
                    }
                });
            }
        }


        // Add input event listeners to the fields
        $("#start-date, #end-date, #branchSelect").on('input', makeAjaxRequest);
        // Add a click event listener to the submit button
        $("#submit").on('click', function (e) {
            e.preventDefault();
            // Make the second POST request with selected slots
            const secondPOSTData = {
                Start_date: formattedStartDate, // Update as needed
                End_date: formattedEndDate,   // Update as neededed
                Branch_id: parseInt($("#branchSelect").val()),
                Slots: selectedSlotIDs,          // Update as needed
            };

            const jsonString = JSON.stringify(secondPOSTData);

            // Perform the second POST request here with the secondPOSTData
            $.ajax({
                url: '/admin/multi/bookings/' + id,
                method: 'POST',
                data: jsonString,
                contentType: 'application/json',
                dataType: 'json',
                success: function (response) {
                    console.log(response);
                }
            });
        });
    });
</script>
</body>

</html>